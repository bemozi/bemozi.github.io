<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seamless Reactive Editor</title>
    <style>
        :root {
            --bg: #1e1e1e; --header-bg: #2d2d2d; --gutter-bg: #252525; --sidebar-bg: #252525;
            --text: #dcdcdc; --border: #333; --accent: #444; --input-bg: #3c3c3c;
            --folder-color: #dcb67a; --selection-bg: rgba(0, 122, 255, 0.35);
            --selection-text: #ffffff; --lh: 1.5; --base-fs: 16px; --header-h: 55px;
            --gutter-w: 75px; --scrollbar-thumb: #444; --scrollbar-track: transparent;
        }
        body[data-theme="light"] {
            --bg: #ffffff; --header-bg: #f3f3f3; --gutter-bg: #f8f8f8; --sidebar-bg: #f8f8f8;
            --text: #333333; --border: #ddd; --accent: #eee; --input-bg: #ffffff;
            --folder-color: #90a4ae; --selection-bg: rgba(0, 120, 215, 0.25);
            --selection-text: inherit; --scrollbar-thumb: #ccc;
        }
        ::selection { background: var(--selection-bg); color: var(--selection-text); }
        * { box-sizing: border-box; }
        body, html { 
            margin: 0; padding: 0; height: 100%; overflow: hidden; 
            background: var(--bg); font-family: 'Segoe UI', sans-serif; 
            color: var(--text); transition: background 0.2s; font-size: var(--base-fs);
            user-select: none; -webkit-user-select: none;
        }
        .main-wrapper { display: flex; height: 100vh; flex-direction: column; }
        .main-header {
            height: var(--header-h); background: var(--header-bg); 
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 10px; flex-shrink: 0; z-index: 10;
        }
        .app-container { display: flex; flex-grow: 1; overflow: hidden; width: 100%; }
        #sidebar {
            width: 0; background: var(--sidebar-bg); display: flex; 
            flex-direction: column; transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0; position: relative; overflow: hidden; 
        }
        body.sidebar-open #sidebar { min-width: 330px; }
        .sidebar-content-wrapper { display: flex; flex-direction: column; flex-grow: 1; border-right: 1px solid var(--border); overflow: hidden; }
        #sidebarControls { padding: 10px; display: none; flex-direction: column; gap: 10px; border-bottom: 1px solid var(--border); }
        #filterActions { display: flex; align-items: center; gap: 4px; flex-wrap: wrap; }
        body.full-explorer #sidebar { width: 100% !important; min-width: 100% !important; }
        body.full-explorer .sidebar-content-wrapper { border-right: none; }
        body.full-explorer .gutter-column, body.full-explorer .editor-column { display: none; }
        body.full-explorer #expandSidebarBtn { margin-left: auto; }
        #fileFilter { width: 100%; background: var(--input-bg); border: 1px solid var(--border); color: var(--text); padding: 8px; border-radius: 4px; font-size: var(--base-fs); outline: none; user-select: text; -webkit-user-select: text; }
        .gutter-column { width: var(--gutter-w); display: flex; flex-direction: column; border-right: 1px solid var(--border); background: var(--gutter-bg); flex-shrink: 0; }
        .editor-column { flex-grow: 1; display: flex; flex-direction: column; min-width: 0; position: relative; }
        .icon-btn { background: transparent; border: 1px solid transparent; color: var(--text); width: 40px; height: 40px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0.7; flex-shrink: 0; }
        .icon-btn:hover:not(:disabled) { background: var(--accent); opacity: 1; }
        .icon-btn:disabled { opacity: 0.2; cursor: default; }
        .icon-btn.active-toggle { background: var(--selection-bg); opacity: 1; border-color: rgba(0, 122, 255, 0.5); }
        .icon-btn svg { width: 22px; height: 22px; fill: none; stroke: currentColor; stroke-width: 2; }
        .sun-icon { display: block; } .moon-icon { display: none; }
        body[data-theme="light"] .sun-icon { display: none; }
        body[data-theme="light"] .moon-icon { display: block; }
        .locked-icon, .unlocked-icon { display: none; }
        .is-unlocked .unlocked-icon { display: block; }
        body:not(.is-unlocked) .locked-icon { display: block; }
        .is-unlocked #lockBtn { color: #f39c12; opacity: 1; }
        #fileList, .editor-viewport { flex-grow: 1; overflow-y: auto; overflow-x: hidden; }
        #fileList::-webkit-scrollbar, .editor-viewport::-webkit-scrollbar { width: 8px; }
        #fileList::-webkit-scrollbar-track, .editor-viewport::-webkit-scrollbar-track { background: var(--scrollbar-track); }
        #fileList::-webkit-scrollbar-thumb, .editor-viewport::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 10px; border: 2px solid var(--bg); }
        #fileList::-webkit-scrollbar-thumb { border-color: var(--sidebar-bg); }
        .entry-item { padding: 10px 15px; cursor: pointer; display: flex; align-items: center; gap: 12px; font-size: var(--base-fs); white-space: nowrap; }
        .entry-item:hover { background: var(--accent); }
        .entry-item.active { background: var(--accent); }
        .entry-item.selected { background: var(--selection-bg); }
        .line-numbers { flex-grow: 1; color: #6e7681; text-align: center; padding-top: 10px; font-family: 'Consolas', monospace; font-size: var(--base-fs); line-height: var(--lh); user-select: none; overflow: hidden; }
        .editor-viewport { position: relative; }
        #editor { width: 100%; min-height: 100%; padding: 10px; outline: none; font-family: 'Consolas', monospace; font-size: var(--base-fs); line-height: var(--lh); white-space: pre; word-break: break-all; tab-size: 4; user-select: text; -webkit-user-select: text; -webkit-user-modify: read-write-plaintext-only; }
        #playPauseBtn .pause-icon { display: none; }
        #playPauseBtn.is-playing .play-icon { display: none; }
        #playPauseBtn.is-playing .pause-icon { display: block; }
        #audioTimer { font-family: 'Consolas', monospace; font-size: 13px; opacity: 0.6; margin-right: 8px; display: none; cursor: pointer; pointer-events: auto; user-select: none; }
        #audioTimer:hover { opacity: 1; }
        #volumeSlider { width: 80px; height: 4px; cursor: pointer; accent-color: var(--text); display: none; margin-right: 10px; }
        .breadcrumb-container { font-size: 14px; display: flex; align-items: center; overflow: hidden; font-family: 'Segoe UI', sans-serif; color: var(--text); }
        .crumb { color: var(--text); cursor: pointer; padding: 2px 0px; white-space: nowrap; opacity: 0.8; }
        .crumb:hover { opacity: 1; }
        .crumb-sep { color: var(--text); margin: 0 4px; flex-shrink: 0; opacity: 0.4; }
        .crumb-file { cursor: default; font-weight: bold; opacity: 1; }
        footer { height: 42px; background: var(--header-bg); border-top: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; font-size: 14px; color: var(--text); flex-shrink: 0; }
        #stat-container { display: none; align-items: center; gap: 25px; }
        #stat-totals, #stat-pos { color: var(--text); opacity: 0.8; }
        .menu-group { display: flex; align-items: center; gap: 4px; }
        .context-btn { display: none; }
        #selectionCountDisplay { font-weight: bold; color: var(--text); margin-right: 15px; flex-shrink: 0; }
        .zip-icon { color: #f1c40f !important; }
        .audio-icon { color: #a29bfe !important; }
    </style>
</head>
<body data-theme="dark">

<div class="main-wrapper">
    <header class="main-header">
        <div class="menu-group">
            <button class="icon-btn" id="openBtn" title="Open Directory">
                <svg viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
            </button>
            <button class="icon-btn context-btn" id="lockBtn" title="Toggle Edit Mode">
                <svg class="locked-icon" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                <svg class="unlocked-icon" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>
            </button>
            <button class="icon-btn" id="undoBtn" disabled title="Undo"><svg viewBox="0 0 24 24"><path d="M9 14L4 9l5-5"/><path d="M20 20v-7a4 4 0 0 0-4-4H4"/></svg></button>
            <button class="icon-btn" id="redoBtn" disabled title="Redo"><svg viewBox="0 0 24 24"><path d="M15 14l5-5-5-5"/><path d="M4 20v-7a4 4 0 0 1 4-4h12"/></svg></button>
        </div>

        <div class="menu-group">
            <span id="audioTimer" title="Click to toggle Remaining/Current View">00</span>
            <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.15" title="Volume">
            <button class="icon-btn" id="playPauseBtn" disabled title="Play/Pause Audio">
                <svg class="play-icon" viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                <svg class="pause-icon" viewBox="0 0 24 24"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
            </button>
            <button class="icon-btn" id="decFontBtn" title="Decrease Text Size">
                <svg viewBox="0 0 24 24"><line x1="5" y1="12" x2="19" y2="12"/></svg>
            </button>
            <button class="icon-btn" id="incFontBtn" title="Increase Text Size">
                <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            </button>
            <button class="icon-btn" id="themeBtn" title="Toggle Theme">
                <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2m0 18v2M4.2 4.2l1.4 1.4m12.8 12.8l1.4 1.4M1 12h2m18 0h2M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4"/></svg>
                <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
            </button>
        </div>
    </header>

    <div class="app-container">
        <div id="sidebar">
            <div class="sidebar-content-wrapper">
                <div id="sidebarControls">
                    <div id="filterActions">
                        <button class="icon-btn context-btn" id="upBtn" disabled title="Up to Parent"><svg viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg></button>
                        <button class="icon-btn context-btn" id="forwardBtn" disabled title="Go Forward/Back to Child"><svg viewBox="0 0 24 24"><path d="M9 6l6 6-6 6"/></svg></button>
                        <button class="icon-btn context-btn" id="newFileBtn" title="New File"><svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg></button>
                        <button class="icon-btn context-btn" id="newDirBtn" title="New Folder"><svg viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2v11"/><path d="M12 11v6M9 14h6"/></svg></button>
                        <button class="icon-btn context-btn" id="multiSelectBtn" title="Multiple Select"><svg viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg></button>
                        <button class="icon-btn context-btn" id="deleteBtn" disabled title="Delete Selected"><svg viewBox="0 0 24 24"><path d="M3 6h18m-2 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                        <button class="icon-btn context-btn" id="zipBtn" title="Create ZIP in Folder"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></button>
                        <button class="icon-btn context-btn" id="recursiveBtn" title="Recursive Filter"><svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg></button>
                        <button class="icon-btn context-btn" id="expandSidebarBtn" title="Toggle Full Width Explorer">
                            <svg class="expand-icon" viewBox="0 0 24 24"><path d="M13 17l5-5-5-5M6 17l5-5-5-5"/></svg>
                            <svg class="collapse-icon" viewBox="0 0 24 24"><path d="M11 17l-5-5 5-5M18 17l-5-5 5-5"/></svg>
                        </button>
                    </div>
                    <input type="text" id="fileFilter" placeholder="Filter" spellcheck="false">
                </div>
                <div id="fileList"></div>
            </div>
        </div>

        <div class="gutter-column">
            <div class="line-numbers" id="lineNumbers"></div>
        </div>

        <div class="editor-column">
            <div class="editor-viewport" id="viewport">
                <div id="editor" contenteditable="false" spellcheck="false"></div>
            </div>
        </div>
    </div>

    <footer>
        <div style="display:flex; align-items: center; overflow: hidden;">
            <div id="selectionCountDisplay"></div>
            <div class="breadcrumb-container" id="pathDisplay"></div>
            <div id="sync-status" style="color: #4ade80; font-weight: bold; opacity: 0; transition: opacity 0.3s; margin-left: 15px; flex-shrink: 0;">‚óè Synced</div>
        </div>
        <div id="stat-container" style="flex-shrink: 0;">
            <span id="stat-pos" style="display:none; margin-right: 25px;">Line : 1 Offset : 0</span>
            <span id="stat-totals"></span>
        </div>
    </footer>
</div>

<script>
    window.addEventListener('contextmenu', (e) => e.preventDefault());

    const editor = document.getElementById('editor');
    const lineNumbers = document.getElementById('lineNumbers');
    const viewport = document.getElementById('viewport');
    const sidebar = document.getElementById('sidebar');
    const fileList = document.getElementById('fileList');
    const openBtn = document.getElementById('openBtn');
    const lockBtn = document.getElementById('lockBtn');
    const expandBtn = document.getElementById('expandSidebarBtn');
    const multiSelectBtn = document.getElementById('multiSelectBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const zipBtn = document.getElementById('zipBtn');
    const newFileBtn = document.getElementById('newFileBtn');
    const newDirBtn = document.getElementById('newDirBtn');
    const recursiveBtn = document.getElementById('recursiveBtn');
    const statPos = document.getElementById('stat-pos');
    const statTotals = document.getElementById('stat-totals');
    const statContainer = document.getElementById('stat-container');
    const pathDisplay = document.getElementById('pathDisplay');
    const fileFilter = document.getElementById('fileFilter');
    const sidebarControls = document.getElementById('sidebarControls');
    const upBtn = document.getElementById('upBtn');
    const forwardBtn = document.getElementById('forwardBtn');
    const selectionCountDisplay = document.getElementById('selectionCountDisplay');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const audioTimer = document.getElementById('audioTimer');
    const volumeSlider = document.getElementById('volumeSlider');
    const themeBtn = document.getElementById('themeBtn');
    const incFontBtn = document.getElementById('incFontBtn');
    const decFontBtn = document.getElementById('decFontBtn');

    let currentFileHandle = null;
    let currentDirHandle = null;
    let rootHandle = null;
    let navHistory = []; 
    let historyIndex = -1;
    let baseFontSize = 16;
    let currentEntries = [];
    let isMultiSelect = false;
    let isRecursiveFilter = false;
    let selectedHandles = new Set();
    
    let isInsideZip = false;
    let audioContext = null;
    let streamNode = null;
    let hiddenAudio = null; 
    let timerInterval = null;
    let showRemainingTime = true; 

    const audioExtensions = ['.mp3', '.wav', '.ogg', '.m4a', '.flac'];

    function getCursorPosition() {
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
            const range = selection.getRangeAt(0);
            const preCaretRange = range.cloneRange();
            preCaretRange.selectNodeContents(editor);
            preCaretRange.setEnd(range.endContainer, range.endOffset);
            return { lineNum: preCaretRange.toString().split(/\r\n|\r|\n/).length, offset: preCaretRange.toString().length };
        }
        return { lineNum: 1, offset: 0 };
    }

    function updateEditorUI() {
        const text = editor.innerText;
        let lines = text.split(/\r\n|\r|\n/);
        if (text.endsWith('\n') || text === '') lines = text === '' ? [""] : [...lines, ""];
        lineNumbers.innerHTML = lines.map((_, i) => `<div>${i + 1}</div>`).join('');
        const pos = getCursorPosition();
        statPos.style.display = 'inline';
        statPos.textContent = `Line : ${pos.lineNum} Offset : ${pos.offset}`;
        statTotals.textContent = `${text.length} chars - ${lines.length} lines`;
    }

    editor.oninput = updateEditorUI;
    editor.onclick = updateEditorUI;
    editor.onkeyup = updateEditorUI;

    openBtn.onclick = async () => {
        try {
            rootHandle = await window.showDirectoryPicker({ mode: 'readwrite' });
            isInsideZip = false;
            document.body.classList.add('sidebar-open');
            sidebar.style.width = '330px'; 
            document.querySelectorAll('.context-btn').forEach(btn => btn.style.display = 'flex');
            sidebarControls.style.display = 'flex';
            await applyNavigationState(rootHandle, true);
        } catch (e) { console.error(e); }
    };

    async function applyNavigationState(state, pushToHistory = true) {
        isInsideZip = false; currentDirHandle = state;
        selectedHandles.clear(); updateDeleteBtn(); updateSelectionUI();
        currentEntries = [];
        try { for await (const entry of state.values()) currentEntries.push(entry); } catch (e) {}
        renderFilteredList(); await updateBreadcrumbs(state);
        
        if (pushToHistory) {
            navHistory = navHistory.slice(0, historyIndex + 1);
            navHistory.push(state);
            historyIndex++;
        }
        upBtn.disabled = historyIndex <= 0;
        forwardBtn.disabled = historyIndex >= navHistory.length - 1;
    }

    async function updateBreadcrumbs(folderHandle, fileName) {
        pathDisplay.innerHTML = '';
        if (!rootHandle) return;
        const rootCrumb = Object.assign(document.createElement('span'), {className: 'crumb', textContent: rootHandle.name});
        rootCrumb.onclick = () => applyNavigationState(rootHandle, true);
        pathDisplay.appendChild(rootCrumb);
        if (folderHandle && folderHandle !== rootHandle) {
            const path = await rootHandle.resolve(folderHandle);
            if (path) {
                path.forEach((folder, index) => {
                    pathDisplay.appendChild(Object.assign(document.createElement('span'), {className:'crumb-sep', textContent:'/'}));
                    const crumb = Object.assign(document.createElement('span'), {className: 'crumb', textContent: folder});
                    crumb.onclick = async () => {
                        let cur = rootHandle;
                        for(const p of path.slice(0, index+1)) cur = await cur.getDirectoryHandle(p);
                        applyNavigationState(cur, true);
                    };
                    pathDisplay.appendChild(crumb);
                });
            }
        }
        if (fileName) {
            pathDisplay.appendChild(Object.assign(document.createElement('span'), {className:'crumb-sep', textContent:'/'}));
            pathDisplay.appendChild(Object.assign(document.createElement('span'), {className:'crumb crumb-file', textContent:fileName}));
        }
    }

    async function* getFilesRecursive(dirHandle, filter) {
        for await (const entry of dirHandle.values()) {
            if (entry.name.toLowerCase().includes(filter)) yield { entry, parent: dirHandle };
            if (entry.kind === 'directory') yield* getFilesRecursive(entry, filter);
        }
    }

    async function renderFilteredList() {
        fileList.innerHTML = '';
        const filter = fileFilter.value.toLowerCase();
        let displayEntries = [];
        if (isRecursiveFilter && filter !== '') {
            for await (const item of getFilesRecursive(currentDirHandle, filter)) displayEntries.push(item.entry);
        } else {
            displayEntries = currentEntries.filter(e => !filter || e.name.toLowerCase().includes(filter));
        }
        displayEntries.sort((a,b) => (a.kind === b.kind ? a.name.localeCompare(b.name) : (a.kind === 'directory' ? -1 : 1)))
            .forEach(e => {
                const item = Object.assign(document.createElement('div'), {className: 'entry-item'});
                if (selectedHandles.has(e)) item.classList.add('selected');
                const isZip = e.name.toLowerCase().endsWith('.zip');
                const isAudio = audioExtensions.includes('.' + e.name.split('.').pop().toLowerCase());
                item.innerHTML = (e.kind === 'directory' ? `<svg style="color:var(--folder-color)" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8z"/></svg>` : 
                                                 `<svg class="${isZip?'zip-icon':(isAudio?'audio-icon':'')}" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><path d="M13 2v7h7"/></svg>`) + `<span>${e.name}</span>`;
                item.onclick = async () => {
                    if (isMultiSelect) { selectedHandles.has(e) ? selectedHandles.delete(e) : selectedHandles.add(e); updateDeleteBtn(); updateSelectionUI(); renderFilteredList(); }
                    else if (e.kind === 'directory') applyNavigationState(e, true);
                    else if (isAudio) initStreamingAudio(await e.getFile(), e.name);
                    else { loadFile(e, item); document.body.classList.remove('full-explorer'); }
                };
                fileList.appendChild(item);
            });
    }

    function formatTime(seconds) {
        if (isNaN(seconds) || seconds < 0) return "00";
        const absS = Math.floor(seconds);
        const h = Math.floor(absS / 3600), m = Math.floor((absS % 3600) / 60), s = absS % 60;
        if (h > 0) return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        else if (m > 0) return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        return String(s).padStart(2, '0');
    }

    function updateTimerDisplay() {
        if (!hiddenAudio) return;
        audioTimer.textContent = showRemainingTime ? formatTime(hiddenAudio.duration - hiddenAudio.currentTime) : `${formatTime(hiddenAudio.currentTime)} / ${formatTime(hiddenAudio.duration)}`;
    }

    audioTimer.onclick = () => { showRemainingTime = !showRemainingTime; updateTimerDisplay(); };
    volumeSlider.oninput = () => { if (hiddenAudio) hiddenAudio.volume = volumeSlider.value; };

    async function initStreamingAudio(file, name) {
        if (hiddenAudio) { hiddenAudio.pause(); URL.revokeObjectURL(hiddenAudio.src); }
        if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
        if (!hiddenAudio) {
            hiddenAudio = new Audio();
            hiddenAudio.crossOrigin = "anonymous";
            streamNode = audioContext.createMediaElementSource(hiddenAudio);
            streamNode.connect(audioContext.destination);
            hiddenAudio.onplay = () => { playPauseBtn.classList.add('is-playing'); timerInterval = setInterval(updateTimerDisplay, 500); };
            hiddenAudio.onpause = () => { playPauseBtn.classList.remove('is-playing'); clearInterval(timerInterval); };
            hiddenAudio.onended = () => { playPauseBtn.classList.remove('is-playing'); clearInterval(timerInterval); updateTimerDisplay(); volumeSlider.style.display = 'none'; };
        }
        hiddenAudio.src = URL.createObjectURL(file);
        hiddenAudio.volume = volumeSlider.value;
        playPauseBtn.disabled = false; audioTimer.style.display = 'inline'; volumeSlider.style.display = 'inline-block';
        showRemainingTime = true; updateBreadcrumbs(currentDirHandle, name);
        if (audioContext.state === 'suspended') await audioContext.resume();
        hiddenAudio.play();
    }

    playPauseBtn.onclick = () => { if (!hiddenAudio) return; hiddenAudio.paused ? hiddenAudio.play() : hiddenAudio.pause(); };

    async function loadFile(h, el) {
        currentFileHandle = h; 
        const file = await h.getFile();
        editor.innerText = await file.text();
        statContainer.style.display = 'flex'; updateEditorUI();
        await updateBreadcrumbs(currentDirHandle, h.name);
        document.querySelectorAll('.entry-item').forEach(i => i.classList.remove('active'));
        el?.classList.add('active');
    }

    /* --- SAFE DEFLATE & ZIP ENGINE --- */
    function crc32(data) {
        let crc = 0 ^ -1;
        const table = crc32.table || (crc32.table = (() => {
            const t = [];
            for (let i = 0; i < 256; i++) {
                let c = i;
                for (let j = 0; j < 8; j++) c = (c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1);
                t[i] = c;
            }
            return t;
        })());
        for (let i = 0; i < data.length; i++) crc = (crc >>> 8) ^ table[(crc ^ data[i]) & 0xFF];
        return (crc ^ -1) >>> 0;
    }

    /** * SAFE DEFLATE (No Compression / Stored Block logic)
     * For maximum OS compatibility without large libraries, we wrap 
     * data in standard DEFLATE block headers (Type 0).
     */
    function safeDeflate(data) {
        const out = [];
        let pos = 0;
        while (pos < data.length) {
            const chunk = data.slice(pos, pos + 65535);
            pos += chunk.length;
            const last = pos >= data.length ? 1 : 0;
            const len = chunk.length;
            const nlen = (~len & 0xFFFF);
            out.push(last, len & 0xFF, (len >> 8) & 0xFF, nlen & 0xFF, (nlen >> 8) & 0xFF);
            out.push(...chunk);
        }
        return new Uint8Array(out);
    }

    zipBtn.onclick = async () => {
        if (!currentDirHandle || isInsideZip) return;
        const now = new Date();
        const baseFormat = `${currentDirHandle.name}_${now.getFullYear()}_${String(now.getMonth()+1).padStart(2,'0')}_${String(now.getDate()).padStart(2,'0')}`;
        let n = 1;
        const existingNames = new Set();
        for await (const entry of currentDirHandle.values()) existingNames.add(entry.name);
        while (existingNames.has(`${baseFormat}_${n}.zip`)) n++;

        const userRename = prompt("ZIP Filename (.zip added automatically):", `${baseFormat}_${n}`);
        if (userRename === null) return;
        const zipFileName = (userRename.trim() || `${baseFormat}_${n}`) + ".zip";

        try {
            const entries = [];
            async function walk(h, path = "") {
                for await (const entry of h.values()) {
                    if (entry.name === zipFileName) continue;
                    if (entry.kind === 'file') {
                        const file = await entry.getFile();
                        const raw = new Uint8Array(await file.arrayBuffer());
                        // Apply compression: Deflate Type 0 (Stored) is the safest cross-platform wrapper
                        const compressed = safeDeflate(raw);
                        entries.push({ name: path + entry.name, raw, compressed, checksum: crc32(raw) });
                    } else if (entry.kind === 'directory') await walk(entry, path + entry.name + "/");
                }
            }
            await walk(currentDirHandle);

            const zipHandle = await currentDirHandle.getFileHandle(zipFileName, { create: true });
            const stream = await zipHandle.createWritable();
            const enc = new TextEncoder();
            let currentOffset = 0;
            const centralDirectoryEntries = [];

            for (const item of entries) {
                const nameBuf = enc.encode(item.name);
                const time = ((now.getHours() << 11) | (now.getMinutes() << 5) | (now.getSeconds() >> 1));
                const date = (((now.getFullYear() - 1980) << 9) | ((now.getMonth() + 1) << 5) | now.getDate());

                const lfh = new Uint8Array(30 + nameBuf.length);
                const dv = new DataView(lfh.buffer);
                dv.setUint32(0, 0x04034b50, true);
                dv.setUint16(4, 20, true);
                dv.setUint16(6, 0, true);
                dv.setUint16(8, 8, true); // Compression method 8 (Deflate)
                dv.setUint16(10, time, true);
                dv.setUint16(12, date, true);
                dv.setUint32(14, item.checksum, true);
                dv.setUint32(18, item.compressed.length, true);
                dv.setUint32(22, item.raw.length, true);
                dv.setUint16(26, nameBuf.length, true);
                dv.setUint16(28, 0, true);
                lfh.set(nameBuf, 30);

                await stream.write(lfh);
                await stream.write(item.compressed);
                centralDirectoryEntries.push({ nameBuf, checksum: item.checksum, time, date, cSize: item.compressed.length, uSize: item.raw.length, offset: currentOffset });
                currentOffset += lfh.length + item.compressed.length;
            }

            const cdStartOffset = currentOffset;
            let cdSize = 0;
            for (const entry of centralDirectoryEntries) {
                const cdh = new Uint8Array(46 + entry.nameBuf.length);
                const dv = new DataView(cdh.buffer);
                dv.setUint32(0, 0x02014b50, true);
                dv.setUint16(4, 20, true);
                dv.setUint16(6, 20, true);
                dv.setUint16(12, entry.time, true);
                dv.setUint16(14, entry.date, true);
                dv.setUint32(16, entry.checksum, true);
                dv.setUint32(20, entry.cSize, true);
                dv.setUint32(24, entry.uSize, true);
                dv.setUint16(28, entry.nameBuf.length, true);
                dv.setUint32(42, entry.offset, true);
                cdh.set(entry.nameBuf, 46);
                await stream.write(cdh);
                cdSize += cdh.length;
            }

            const eocd = new Uint8Array(22);
            const dvE = new DataView(eocd.buffer);
            dvE.setUint32(0, 0x06054b50, true);
            dvE.setUint16(8, centralDirectoryEntries.length, true);
            dvE.setUint16(10, centralDirectoryEntries.length, true);
            dvE.setUint32(12, cdSize, true);
            dvE.setUint32(16, cdStartOffset, true);
            await stream.write(eocd);
            await stream.close();
            applyNavigationState(currentDirHandle, false);
        } catch (err) { alert("ZIP Error: " + err.message); }
    };

    /* --- SIDEBAR & UTILITIES --- */
    function updateDeleteBtn() { deleteBtn.disabled = selectedHandles.size === 0 || isInsideZip; }
    function updateSelectionUI() { selectionCountDisplay.textContent = selectedHandles.size > 0 ? `${selectedHandles.size} selected` : ''; }

    newFileBtn.onclick = async () => { if (!currentDirHandle) return; const name = prompt("New file:"); if (name) { await currentDirHandle.getFileHandle(name, {create:true}); applyNavigationState(currentDirHandle, false); } };
    newDirBtn.onclick = async () => { if (!currentDirHandle) return; const name = prompt("New folder:"); if (name) { await currentDirHandle.getDirectoryHandle(name, {create:true}); applyNavigationState(currentDirHandle, false); } };
    deleteBtn.onclick = async () => { if (selectedHandles.size === 0) return; if (confirm(`Delete ${selectedHandles.size} items?`)) { for (const h of selectedHandles) await currentDirHandle.removeEntry(h.name, {recursive:true}); selectedHandles.clear(); applyNavigationState(currentDirHandle, false); } };
    recursiveBtn.onclick = () => { isRecursiveFilter = !isRecursiveFilter; recursiveBtn.classList.toggle('active-toggle', isRecursiveFilter); renderFilteredList(); };
    fileFilter.oninput = renderFilteredList;
    multiSelectBtn.onclick = () => { isMultiSelect = !isMultiSelect; multiSelectBtn.classList.toggle('active-toggle', isMultiSelect); if(!isMultiSelect) { selectedHandles.clear(); updateSelectionUI(); updateDeleteBtn(); renderFilteredList(); } };
    expandBtn.onclick = () => document.body.classList.toggle('full-explorer');
    themeBtn.onclick = () => document.body.setAttribute('data-theme', document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
    incFontBtn.onclick = () => { baseFontSize += 2; document.documentElement.style.setProperty('--base-fs', baseFontSize + 'px'); updateEditorUI(); };
    decFontBtn.onclick = () => { if (baseFontSize > 8) { baseFontSize -= 2; document.documentElement.style.setProperty('--base-fs', baseFontSize + 'px'); updateEditorUI(); } };
    lockBtn.onclick = () => { const isLocked = editor.contentEditable === 'true'; editor.contentEditable = !isLocked; document.body.classList.toggle('is-unlocked', !isLocked); };
    upBtn.onclick = () => { if (historyIndex > 0) { historyIndex--; applyNavigationState(navHistory[historyIndex], false); } };
    forwardBtn.onclick = () => { if (historyIndex < navHistory.length - 1) { historyIndex++; applyNavigationState(navHistory[historyIndex], false); } };
</script>
</body>
</html>
